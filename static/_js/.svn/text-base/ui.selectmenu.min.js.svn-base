(function(a){a.widget("ui.selectmenu",{_init:function(){var q=this,f=this.options;this.ids=[this.element.attr("id")+"-button",this.element.attr("id")+"-menu"];this._safemouseup=true;this.newelement=a('<a class="'+this.widgetBaseClass+' ui-widget ui-state-default ui-corner-all" id="'+this.ids[0]+'" role="button" href="#" aria-haspopup="true" aria-owns="'+this.ids[1]+'"></a>').insertAfter(this.element);var k=this.element.attr("tabindex");if(k){this.newelement.attr("tabindex",k)}this.newelement.data("selectelement",this.element);this.selectmenuIcon=a('<span class="'+this.widgetBaseClass+'-icon ui-icon"></span>').prependTo(this.newelement).addClass((f.style=="popup")?"ui-icon-triangle-2-n-s":"ui-icon-triangle-1-s");a("label[for="+this.element.attr("id")+"]").attr("for",this.ids[0]).bind("click",function(){q.newelement[0].focus();return false});this.newelement.bind("mousedown",function(i){q._toggle(i);if(f.style=="popup"){q._safemouseup=false;setTimeout(function(){q._safemouseup=true},300)}return false}).bind("click",function(){return false}).keydown(function(j){var i=true;switch(j.keyCode){case a.ui.keyCode.ENTER:i=true;break;case a.ui.keyCode.SPACE:i=false;q._toggle(j);break;case a.ui.keyCode.UP:case a.ui.keyCode.LEFT:i=false;q._moveSelection(-1);break;case a.ui.keyCode.DOWN:case a.ui.keyCode.RIGHT:i=false;q._moveSelection(1);break;case a.ui.keyCode.TAB:i=true;break;default:i=false;q._typeAhead(j.keyCode,"mouseup");break}return i}).bind("mouseover focus",function(){a(this).addClass(q.widgetBaseClass+"-focus ui-state-hover")}).bind("mouseout blur",function(){a(this).removeClass(q.widgetBaseClass+"-focus ui-state-hover")});a(document).mousedown(function(i){q.close(i)});this.element.click(function(){this._refreshValue()}).focus(function(){this.newelement[0].focus()});var d=(f.style=="dropdown")?" ui-corner-bottom":" ui-corner-all";this.list=a('<ul class="'+q.widgetBaseClass+"-menu ui-widget ui-widget-content"+d+'" aria-hidden="true" role="listbox" aria-labelledby="'+this.ids[0]+'" id="'+this.ids[1]+'"></ul>').appendTo("body");var b=[];this.element.find("option").each(function(){b.push({value:a(this).attr("value"),text:q._formatText(jQuery(this).text()),selected:a(this).attr("selected"),classes:a(this).attr("class"),parentOptGroup:a(this).parent("optgroup").attr("label")})});var n=(q.options.style=="popup")?" ui-state-active":"";for(var l in b){var e=a('<li role="presentation"><a href="#" tabindex="-1" role="option" aria-selected="false">'+b[l].text+"</a></li>").data("index",l).addClass(b[l].classes).data("optionClasses",b[l].classes||"").mouseup(function(i){if(q._safemouseup){var j=a(this).data("index")!=q._selectedIndex();q.value(a(this).data("index"));q.select(i);if(j){q.change(i)}q.close(i,true)}return false}).click(function(){return false}).bind("mouseover focus",function(){q._selectedOptionLi().addClass(n);q._focusedOptionLi().removeClass(q.widgetBaseClass+"-item-focus ui-state-hover");a(this).removeClass("ui-state-active").addClass(q.widgetBaseClass+"-item-focus ui-state-hover")}).bind("mouseout blur",function(){if(a(this).is(q._selectedOptionLi())){a(this).addClass(n)}a(this).removeClass(q.widgetBaseClass+"-item-focus ui-state-hover")});if(b[l].parentOptGroup){var m=q.widgetBaseClass+"-group-"+b[l].parentOptGroup;if(this.list.find("li."+m).size()){this.list.find("li."+m+":last ul").append(e)}else{a('<li role="presentation" class="'+q.widgetBaseClass+"-group "+m+'"><span class="'+q.widgetBaseClass+'-group-label">'+b[l].parentOptGroup+"</span><ul></ul></li>").appendTo(this.list).find("ul").append(e)}}else{e.appendTo(this.list)}this.list.bind("mousedown mouseup",function(){return false});if(f.icons){for(var h in f.icons){if(e.is(f.icons[h].find)){e.data("optionClasses",b[l].classes+" "+q.widgetBaseClass+"-hasIcon").addClass(q.widgetBaseClass+"-hasIcon");var p=f.icons[h].icon||"";e.find("a:eq(0)").prepend('<span class="'+q.widgetBaseClass+"-item-icon ui-icon "+p+'"></span>')}}}}this.list.find("li:last").addClass("ui-corner-bottom");if(f.style=="popup"){this.list.find("li:first").addClass("ui-corner-top")}if(f.transferClasses){var r=this.element.attr("class")||"";this.newelement.add(this.list).addClass(r)}var g=this.element.width();this.newelement.width((f.width)?f.width:g);if(f.style=="dropdown"){this.list.width((f.menuWidth)?f.menuWidth:((f.width)?f.width:g))}else{this.list.width((f.menuWidth)?f.menuWidth:((f.width)?f.width-f.handleWidth:g-f.handleWidth))}if(f.maxHeight&&f.maxHeight<this.list.height()){this.list.height(f.maxHeight)}this._optionLis=this.list.find("li:not(."+q.widgetBaseClass+"-group)");this.list.keydown(function(j){var i=true;switch(j.keyCode){case a.ui.keyCode.UP:case a.ui.keyCode.LEFT:i=false;q._moveFocus(-1);break;case a.ui.keyCode.DOWN:case a.ui.keyCode.RIGHT:i=false;q._moveFocus(1);break;case a.ui.keyCode.HOME:i=false;q._moveFocus(":first");break;case a.ui.keyCode.PAGE_UP:i=false;q._scrollPage("up");break;case a.ui.keyCode.PAGE_DOWN:i=false;q._scrollPage("down");break;case a.ui.keyCode.END:i=false;q._moveFocus(":last");break;case a.ui.keyCode.ENTER:case a.ui.keyCode.SPACE:i=false;q.close(j,true);a(j.target).parents("li:eq(0)").trigger("mouseup");break;case a.ui.keyCode.TAB:i=true;q.close(j,true);break;case a.ui.keyCode.ESCAPE:i=false;q.close(j,true);break;default:i=false;q._typeAhead(j.keyCode,"focus");break}return i});if(f.style=="dropdown"){this.newelement.addClass(q.widgetBaseClass+"-dropdown");this.list.addClass(q.widgetBaseClass+"-menu-dropdown")}else{this.newelement.addClass(q.widgetBaseClass+"-popup");this.list.addClass(q.widgetBaseClass+"-menu-popup")}this.newelement.prepend('<span class="'+q.widgetBaseClass+'-status">'+b[this._selectedIndex()].text+"</span>");this.element.hide();if(this.element.attr("disabled")==true){this.disable()}this.value(this._selectedIndex())},destroy:function(){this.element.removeData(this.widgetName).removeClass(this.widgetBaseClass+"-disabled "+this.namespace+"-state-disabled").removeAttr("aria-disabled");a("label[for="+this.newelement.attr("id")+"]").attr("for",this.element.attr("id")).unbind("click");this.newelement.remove();this.list.remove();this.element.show()},_typeAhead:function(f,e){var b=this;if(!b._prevChar){b._prevChar=["",0]}var h=String.fromCharCode(f);c=h.toLowerCase();var d=false;function g(i,j){d=true;a(i).trigger(e);b._prevChar[1]=j}this.list.find("li a").each(function(j){if(!d){var k=a(this).text();if(k.indexOf(h)==0||k.indexOf(c)==0){if(b._prevChar[0]==h){if(b._prevChar[1]<j){g(this,j)}}else{g(this,j)}}}});this._prevChar[0]=h},_uiHash:function(){return{value:this.value()}},open:function(e){var d=this;var b=this.newelement.attr("aria-disabled");if(b!="true"){this._refreshPosition();this._closeOthers(e);this.newelement.addClass("ui-state-active");this.list.appendTo("body").addClass(d.widgetBaseClass+"-open").attr("aria-hidden",false).find("li:not(."+d.widgetBaseClass+"-group):eq("+this._selectedIndex()+") a")[0].focus();if(this.options.style=="dropdown"){this.newelement.removeClass("ui-corner-all").addClass("ui-corner-top")}this._refreshPosition();this._trigger("open",e,this._uiHash())}},close:function(d,b){if(this.newelement.is(".ui-state-active")){this.newelement.removeClass("ui-state-active");this.list.attr("aria-hidden",true).removeClass(this.widgetBaseClass+"-open");if(this.options.style=="dropdown"){this.newelement.removeClass("ui-corner-top").addClass("ui-corner-all")}if(b){this.newelement[0].focus()}this._trigger("close",d,this._uiHash())}},change:function(b){this.element.trigger("change");this._trigger("change",b,this._uiHash())},select:function(b){this._trigger("select",b,this._uiHash())},_closeOthers:function(b){a("."+this.widgetBaseClass+".ui-state-active").not(this.newelement).each(function(){a(this).data("selectelement").selectmenu("close",b)});a("."+this.widgetBaseClass+".ui-state-hover").trigger("mouseout")},_toggle:function(d,b){if(this.list.is("."+this.widgetBaseClass+"-open")){this.close(d,b)}else{this.open(d)}},_formatText:function(b){return this.options.format?this.options.format(b):b},_selectedIndex:function(){return this.element[0].selectedIndex},_selectedOptionLi:function(){return this._optionLis.eq(this._selectedIndex())},_focusedOptionLi:function(){return this.list.find("."+this.widgetBaseClass+"-item-focus")},_moveSelection:function(e){var d=parseInt(this._selectedOptionLi().data("index"),10);var b=d+e;return this._optionLis.eq(b).trigger("mouseup")},_moveFocus:function(f){if(!isNaN(f)){var e=parseInt(this._focusedOptionLi().data("index"),10);var d=e+f}else{var d=parseInt(this._optionLis.filter(f).data("index"),10)}if(d<0){d=0}if(d>this._optionLis.size()-1){d=this._optionLis.size()-1}var b=this.widgetBaseClass+"-item-"+Math.round(Math.random()*1000);this._focusedOptionLi().find("a:eq(0)").attr("id","");this._optionLis.eq(d).find("a:eq(0)").attr("id",b)[0].focus();this.list.attr("aria-activedescendant",b)},_scrollPage:function(d){var b=Math.floor(this.list.outerHeight()/this.list.find("li:first").outerHeight());b=(d=="up")?-b:b;this._moveFocus(b)},_setData:function(b,d){this.options[b]=d;if(b=="disabled"){this.close();this.element.add(this.newelement).add(this.list)[d?"addClass":"removeClass"](this.widgetBaseClass+"-disabled "+this.namespace+"-state-disabled").attr("aria-disabled",d)}},value:function(b){if(arguments.length){this.element[0].selectedIndex=b;this._refreshValue();this._refreshPosition()}return this.element[0].selectedIndex},_refreshValue:function(){var e=(this.options.style=="popup")?" ui-state-active":"";var d=this.widgetBaseClass+"-item-"+Math.round(Math.random()*1000);this.list.find("."+this.widgetBaseClass+"-item-selected").removeClass(this.widgetBaseClass+"-item-selected"+e).find("a").attr("aria-selected","false").attr("id","");this._selectedOptionLi().addClass(this.widgetBaseClass+"-item-selected"+e).find("a").attr("aria-selected","true").attr("id",d);var b=this.newelement.data("optionClasses")?this.newelement.data("optionClasses"):"";var f=this._selectedOptionLi().data("optionClasses")?this._selectedOptionLi().data("optionClasses"):"";this.newelement.removeClass(b).data("optionClasses",f).addClass(f).find("."+this.widgetBaseClass+"-status").html(this._selectedOptionLi().find("a:eq(0)").html());this.list.attr("aria-activedescendant",d)},_refreshPosition:function(){this.list.css("left",this.newelement.offset().left);var b=this.newelement.offset().top;var d=this.list[0].scrollTop;this.list.find("li:lt("+this._selectedIndex()+")").each(function(){d-=a(this).outerHeight()});if(this.newelement.is("."+this.widgetBaseClass+"-popup")){b+=d;this.list.css("top",b)}else{b+=this.newelement.height();this.list.css("top",b)}}});a.extend(a.ui.selectmenu,{getter:"value",version:"@VERSION",eventPrefix:"selectmenu",defaults:{transferClasses:true,style:"popup",width:null,menuWidth:null,handleWidth:26,maxHeight:null,icons:null,format:null}})})(jQuery);